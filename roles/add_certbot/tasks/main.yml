# The following sets up SSL certificate using Let's Encrypt, enables SSL site
# and schedules automatic renewal of the certificates. Parameters are required.
# Note: This certbot role is for apache2 and won't work for nginx

# usage:
# - role: add_certbot
#   vars:
#     domain: "{{ downloads_domain }}"
#     config_file: name.of.file.conf
#     email: "{{ systems_email }}"

- name: Check if email exists
  fail:
    msg: "Please add email to this role"
  when: email is undefined

- name: Check if domain exists
  fail:
    msg: "Please add domain to this role"
  when: domain is undefined

- name: Check if config file name exists
  fail:
    msg: "Please add config file name to this role"
  when: config_file is undefined

- name: Install certbot for apache
  apt:
    pkg:
      - certbot
      - python3-certbot-apache
    state: present
    update_cache: yes

- name: Get LetsEncrypt certificates
  shell: |
    certbot --apache -n --agree-tos --email {{ email }} -d {{ domain }}
  args:
    creates: "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"

- name: Enable SSL site
  command: a2ensite {{ config_file }}
  notify: reload apache

- name: Set up renewal cron job
  cron:
    name: "Renew Let's Encrypt certificates"
    job: "certbot renew --quiet" # 'quiet' is used to suppress the outputs
    state: present
    minute: 0
    hour: 0
    weekday: 1
  notify: reload apache
