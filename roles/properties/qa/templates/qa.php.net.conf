<VirtualHost *:80>
	ServerName {{ qa_domain }}
	ServerAlias {{ qa_domain_alias }}

	ServerAdmin {{ systems_email }}
	Redirect / https://qa.php.net/
</VirtualHost>

<IfModule mod_ssl.c>
<VirtualHost *:443>
	ServerAdmin {{ systems_email }}
	ServerName {{ qa_domain }}
	ServerAlias {{ qa_domain_alias }}

	DocumentRoot {{ qa_docroot }}/{{ qa_domain }}

	RewriteEngine on
	# Outdated reports that are just used by scrapers
	RewriteRule ^/build.php - [F]
	RewriteRule ^/reports/details - [F]
	RewriteRule ^/reports/run_tests - [F]
	RewriteRule ^/reports/viewreports - [F]
	RewriteRule ^/buildtest-submit.php - [F]

	# Redirect content to new location
	RewriteRule ^/$                   https://www.php.net/release-candidates.php
	RewriteRule ^/expectf_details.php https://php.github.io/php-src/miscellaneous/writing-tests.html#id4 [NE]
	RewriteRule ^/handling-bugs.php   https://github.com/php/php-src/issues/new/choose
	RewriteRule ^/howtohelp.php       https://php.github.io/php-src/miscellaneous/writing-tests.html
	RewriteRule ^/howto_phpt.php      https://php.github.io/php-src/miscellaneous/writing-tests.html
	RewriteRule ^/howto_phpunit.php   https://php.github.io/php-src/miscellaneous/writing-tests.html
	RewriteRule ^/list_builds.php     https://github.com/php/php-src/actions
	RewriteRule ^/pftt.php            https://github.com/php/php-src/actions
	RewriteRule ^/phpt_details.php    https://php.github.io/php-src/miscellaneous/writing-tests.html#phpt-structure-details [NE]
	RewriteRule ^/projects            https://www.php.net/release-candidates.php
	RewriteRule ^/rc                  https://www.php.net/release-candidates.php
	RewriteRule ^/running-tests.php   https://php.github.io/php-src/miscellaneous/running-tests.html
	RewriteRule ^/write-test.php      https://php.github.io/php-src/miscellaneous/writing-tests.html
	RewriteRule ^/sample_tests        https://php.github.io/php-src/miscellaneous/writing-tests.html#samples [NE]

	# API Requests
	RewriteCond %{QUERY_STRING} ^type=qa-releases$
	RewriteRule ^/api.php$      https://www.php.net/release-candidates.php?format=serialize

	RewriteCond %{QUERY_STRING} ^type=qa-releases&format=serialise$
	RewriteRule ^/api.php$      https://www.php.net/release-candidates.php?format=serialize

	RewriteCond %{QUERY_STRING} ^type=qa-releases&format=json$
	RewriteRule ^/api.php$      https://www.php.net/release-candidates.php?format=json

	RewriteCond %{QUERY_STRING} ^type=qa-releases&format=json&only=dev_versions$
	RewriteRule ^/api.php$      https://www.php.net/release-candidates.php?format=json&only=dev_versions

	RewriteRule ^/api.php$      https://www.php.net/release-candidates.php

	# 403 Everything else besides robots.txt
	RewriteCond %{REQUEST_URI} !^/robots.txt
	RewriteRule ^/ - [F]

	<Directory {{ qa_docroot }}/{{ qa_domain }}/>
		Options FollowSymLinks 
		AllowOverride None
		Order allow,deny
		Allow from all
	</Directory>

	# Logging
	ErrorLog ${APACHE_LOG_DIR}/{{ qa_domain }}-error.log
	CustomLog ${APACHE_LOG_DIR}/{{ qa_domain }}-access.log combined

	# TLS Configuration with self-signed certificates
	SSLEngine on
	SSLCertificateFile /etc/ssl/certs/php-self-signed.crt
	SSLCertificateKeyFile /etc/ssl/certs/php-self-signed.key
</VirtualHost>
</IfModule>
