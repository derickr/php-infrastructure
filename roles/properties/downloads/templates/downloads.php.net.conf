<VirtualHost *:80>
	# Host and Document Root
	ServerName {{ downloads_domain }}
	ServerAlias {{ downloads_domain_alias }}
	Redirect / https://{{ downloads_domain }}/

	# Logging
	ErrorLog ${APACHE_LOG_DIR}/{{ downloads_domain }}-error.log
	CustomLog ${APACHE_LOG_DIR}/{{ downloads_domain }}-access.log combined
</VirtualHost>

<VirtualHost *:443>
	# Host and Document Root
	ServerName {{ downloads_domain }}
	ServerAlias {{ downloads_domain_alias }}
	DocumentRoot {{downloads_docroot}}/{{ downloads_domain }}/public

	<Directory {{downloads_docroot}}/{{ downloads_domain }}/>
		Options FollowSymLinks MultiViews
		AllowOverride None
		Require all granted
	</Directory>

	# Logging
	ErrorLog ${APACHE_LOG_DIR}/{{ downloads_domain }}-error.log
	CustomLog ${APACHE_LOG_DIR}/{{ downloads_domain }}-access.log combined

	# TLS Configuration with self-signed certificates
	SSLEngine on
	SSLCertificateFile /etc/ssl/certs/php-self-signed.crt
	SSLCertificateKeyFile /etc/ssl/certs/php-self-signed.key

	# Property Specific Changes
	RewriteEngine On
	RewriteRule ^/$ https://php.net/ [L]

	# Handle Authorization Header
	RewriteCond %{HTTP:Authorization} .
	RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

	# Send all api requests to index.php
	RewriteCond %{REQUEST_URI} ^/api
	RewriteCond %{REQUEST_FILENAME} !-d
	RewriteCond %{REQUEST_FILENAME} !-f
	RewriteRule ^ index.php [L]

	<FilesMatch ".+\.phps$">
		SetHandler application/x-httpd-php-source
		# Deny access to raw php sources by default
		# To re-enable it's recommended to enable access to the files
		# only in specific virtual host or directory
		Require all granted
	</FilesMatch>

	<Directory /home/windows/public_html>
		ErrorDocument 404  /redirect.php
	</Directory>

	# Secret Environment Variables
	Include /local/this-box/apache.conf
</VirtualHost>
