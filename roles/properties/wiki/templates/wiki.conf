<VirtualHost *:80>
        ServerName {{ wiki_domain }}
        Redirect / https://{{ wiki_domain }}/
</VirtualHost>

<VirtualHost *:443>
        ServerName {{ wiki_domain }}

        ServerAdmin {{ systems_email }}
        DocumentRoot {{ wiki_docroot }}/dokuwiki

        SSLEngine on
        SSLCertificateFile /etc/ssl/certs/php-self-signed.crt
        SSLCertificateKeyFile /etc/ssl/certs/php-self-signed.key

        # HSTS (mod_headers is required) (15768000 seconds = 6 months)
        Header always set Strict-Transport-Security "max-age=15768000"

        ErrorLog ${APACHE_LOG_DIR}/wiki-php-net.error.log
        CustomLog ${APACHE_LOG_DIR}/wiki-php-net.access.log combined

        LogLevel warn

        SetEnv dokuwikitoken {{ wiki_token }}
        SetEnv WIKI_DATA_DIR {{ wiki_data_dir }}
        SetEnv WIKI_AUTH_FILE {{ wiki_data_dir }}/auth/users.auth.php
        <Directory {{ wiki_docroot }}/dokuwiki>
                Options Indexes FollowSymLinks
                AllowOverride All
                Require all granted

                RewriteEngine on
                RewriteBase /
                RewriteRule ^lib                      - [L]
                RewriteRule ^doku.php                 - [L]
                RewriteRule ^feed.php                 - [L]
                RewriteRule ^.well-known              - [L]
                RewriteRule ^_media/(.*)              lib/exe/fetch.php?media=$1  [QSA,L]
                RewriteRule ^_detail/(.*)             lib/exe/detail.php?media=$1 [QSA,L]
                RewriteRule ^_export/([^/]+)/(.*)     doku.php?do=export_$1&id=$2 [QSA,L]
                RewriteRule ^$                        doku.php  [L]
                RewriteRule (.*)                      doku.php?id=$1  [QSA,L]
                RewriteRule ^index.php$               doku.php
        </Directory>

        <Directory {{ wiki_docroot }}/dokuwiki/bin>
                Require all denied
        </Directory>

        <Directory {{ wiki_docroot }}/dokuwiki/data>
                Require all denied
        </Directory>

        # Newer Dokuwiki versions use Composer
        <Directory {{ wiki_docroot }}/dokuwiki/vendor>
                Require all denied
        </Directory>

        # Forbid all dot files like .git or .svn
        <DirectoryMatch "^\.[gs]|\/\.[gs]">
                Order allow,deny
                Deny from all
        </DirectoryMatch>

        <Directory {{ wiki_docroot }}/dokuwiki/.well-known>
                Order allow,deny
                Allow from all
        </Directory>
</VirtualHost>
