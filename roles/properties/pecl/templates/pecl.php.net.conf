<VirtualHost *:80>
	# Host and Document Root
	ServerName {{ pecl_domain }}
	ServerAlias {{ pecl_domain_alias }}
	Redirect / https://{{ pecl_domain }}/

	# Logging
	ErrorLog ${APACHE_LOG_DIR}/{{ pecl_domain }}-error.log
	CustomLog ${APACHE_LOG_DIR}/{{ pecl_domain }}-access.log combined
</VirtualHost>

<VirtualHost *:443>
	# Host and Document Root
	ServerName {{ pecl_domain }}
	ServerAlias {{ pecl_domain_alias }}
	DocumentRoot {{ pecl_docroot }}/{{ pecl_domain }}/public_html

	<Directory {{ pecl_docroot }}/{{ pecl_domain }}/>
		Options FollowSymLinks MultiViews
		AllowOverride None
		Require all granted
	</Directory>

	# Logging
	ErrorLog ${APACHE_LOG_DIR}/{{ pecl_domain }}-error.log
	CustomLog ${APACHE_LOG_DIR}/{{ pecl_domain }}-access.log combined

	# TLS Configuration with self-signed certificates
	SSLEngine on
	SSLCertificateFile /etc/ssl/certs/php-self-signed.crt
	SSLCertificateKeyFile /etc/ssl/certs/php-self-signed.key

	# Environment Variables
	SetEnv PEAR_DATABASE_DSN {{ pecl_dsn }}
	SetEnv PECL_TMP_DIR {{ pecl_tmp_dir }}
	SetEnv PEAR_REST_DIR {{ pecl_rest_dir }}
	SetEnv PECL_TMP_UPLOADS_DIR {{ pecl_uploads_dir }}
	SetEnv PECL_PACKAGES_DIR {{ pecl_packages_dir }}

	# PHP Settings
	php_value date.timezone UTC
	php_value auto_prepend_file pear-prepend.php
	php_value include_path .:{{ pecl_docroot }}/{{ pecl_domain }}/include:/usr/share/php
	php_value upload_max_filesize 16M

	ErrorDocument 404  /error/404.php

	# Enabled SendFile
	XSendFile On

	# Rewrite Rules
	RewriteEngine On

	RewriteRule /download-docs.php          /doc/index.php [R=301]
	RewriteRule /manual                     /doc/index.php [R=301]
	RewriteRule /rss.php                    /feeds/latest.rss [R=301]

	RewriteRule /feeds/(.+)\.rss$           /feeds/feeds.php?type=$1
	RewriteRule /user/(.+)$                 /account-info.php?handle=$1

	RewriteRule /package/(.+)/(.+)/windows$ /package-info-win.php?package=$1&version=$2
	RewriteRule /package/(.+)/(.+)$         /package-info.php?package=$1&version=$2
	RewriteRule /package/(.+)$              /package-info.php?package=$1

	# Location specific settings
	<Location /get>
		ForceType application/x-httpd-php
	</Location>

	<Location /channel.xml>
		SetEnv no-gzip 1
	</Location>

	<Location /rest>
		SetEnv no-gzip 1
	</Location>

</VirtualHost>
