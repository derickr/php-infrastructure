<VirtualHost *:80>
	# Host and Document Root
	ServerName {{ main_domain }}
	ServerAlias {{ main_domain_alias }}
	Redirect / https://{{ main_domain }}/

	# Logging
	ErrorLog ${APACHE_LOG_DIR}/{{ main_domain }}-error.log
	CustomLog ${APACHE_LOG_DIR}/{{ main_domain }}-access.log combined
</VirtualHost>

<VirtualHost *:443>
	# Host and Document Root
	ServerName {{ main_domain }}
	ServerAlias {{ main_domain_alias }}
	DocumentRoot {{ main_docroot }}/{{ main_domain }}/public

	ServerAdmin {{ master_email }}

	<Directory "{{ main_docroot }}/{{ main_domain }}/public">
		Options All +FollowSymLinks -Indexes
		AllowOverride All
		Require all granted
	</Directory>

	# Logging
	ErrorLog ${APACHE_LOG_DIR}/{{ main_domain }}-error.log
	CustomLog ${APACHE_LOG_DIR}/{{ main_domain }}-access.log combined

	# TLS Configuration with self-signed certificates
	SSLEngine on
	SSLCertificateFile /etc/ssl/certs/php-self-signed.crt
	SSLCertificateKeyFile /etc/ssl/certs/php-self-signed.key

	# Environment Variables
	SetEnv GITHUB_SECRET "{{ github_secret }}"
	SetEnv GITHUB_CLIENT_ID "{{ github_client_id }}"
	SetEnv GITHUB_CLIENT_SECRET "{{ github_client_secret }}"
	SetEnv BUGS_MAGIC_COOKIE "{{ bugs_magic_cookie }}"
	SetEnv DATABASE_USER "{{ main_db_username }}"
	SetEnv DATABASE_NAME "{{ main_db_database }}"
	SetEnv DATABASE_PASSWORD "{{ main_db_password }}"

	# PHP Settings
	php_value include_path .:{{ main_docroot }}/{{ main_domain }}/include

	# Rewrite Rules
	RewriteEngine on
	RewriteRule ^/note/edit/([0-9]+)$ /manage/user-notes.php?action=edit+$1 [R]
	RewriteRule ^/note/(reject|delete)/([0-9]+)$ /manage/user-notes.php?action=$1+$2&report=yes [R]
	RewriteRule ^/note/delete/([0-9]+)/(.*)$ /manage/user-notes.php?action=delete+$1&report=yes&reason=$2 [R]
</VirtualHost>
