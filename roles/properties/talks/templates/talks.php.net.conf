<VirtualHost *:80>
	ServerName {{ talks_domain }}
	ServerAlias {{ talks_domain_alias }}

	ServerAdmin {{ systems_email }}
	Redirect / https://{{ talks_domain }}
</VirtualHost>

<IfModule mod_ssl.c>
<VirtualHost *:443>
	ServerAdmin {{ systems_email }}
	ServerName {{ talks_domain }}
	ServerAlias {{ talks_domain_alias }}

	DocumentRoot {{ talks_docroot }}

	# Logging
	ErrorLog ${APACHE_LOG_DIR}/{{ talks_domain }}-error.log
	CustomLog ${APACHE_LOG_DIR}/{{ talks_domain }}-access.log combined

	# TLS Configuration with self-signed certificates
	SSLEngine on
	SSLCertificateFile /etc/ssl/certs/php-self-signed.crt
	SSLCertificateKeyFile /etc/ssl/certs/php-self-signed.key

	# Property Specific Changes
	php_value include_path .:{{ talks_docroot }}:{{ talks_docroot }}/vendor/pear
	php_admin_flag register_globals on
	php_value error_reporting 7
	php_value session.cache_limiter private
	php_value filter.default special_chars
	php_value display_errors Off

	<Directory {{ talks_docroot }}>
		Require all granted
	</Directory>

	<Location /show>
		ForceType application/x-httpd-php
	</Location>

	<Directory {{ talks_docroot }}/presentations/slides/mvc/example>
		AddType application/x-httpd-php-source .phps
		php_admin_flag engine on

		<FilesMatch "^\.ph(p[345]?|t|tml|ps)$">
			Require all granted
		</FilesMatch>
	</Directory>

	<Directory {{ talks_docroot }}/presentations/slides/mvc/example/model>
		AddType application/x-httpd-php-source .phps
		php_admin_flag engine on
		<FilesMatch "^\.ph(p[345]?|t|tml|ps)$">
			Require all granted
		</FilesMatch>
	</Directory>

	<Directory {{ talks_docroot }}>
		AddType application/x-httpd-php-source .phps
		RewriteEngine On
		RewriteBase /

		# Redirect /show/* to /show.php
		RewriteRule ^show/(.+)$ %{DOCUMENT_ROOT}/show.php/$1 [QSA]

		# Redirect /show2/* to /show2.php
		RewriteRule ^s2/(.+)$ %{DOCUMENT_ROOT}/show2.php/$1 [QSA]

		# Redirect to /presentations/<pres>.html if it exists
		RewriteCond         %{DOCUMENT_ROOT}/presentations/%{REQUEST_URI}.html  -f
		RewriteRule  ^(.+)  %{DOCUMENT_ROOT}/presentations/$1.html  [L]

		RewriteCond %{REQUEST_FILENAME} !-f
		RewriteRule ^([^\.\?/]+)$       /index.php/$1        [QSA]
	</Directory>

	<Directory {{ talks_docroot }}/presentations/slides>
		php_admin_flag engine off
	</Directory>

	<Directory {{ talks_docroot }}/presentations/slides/intro>
		php_admin_flag engine on
	</Directory>

	ErrorDocument 404 /index.php
	ErrorDocument 403 /index.php
</VirtualHost>
</IfModule>
