# Note: backupMain role backs up mysql database and apache2 config as per: https://github.com/php/systems/blob/master/backup-main
# backupOtherProperties role creates tar file of the docroot folder and backs that up
- hosts:
  - "{{ host_name | default('downloads') }}"
  become: yes
  become_user: root
  environment:
    AWS_ACCESS_KEY_ID: "{{ DO_access_key }}"
    AWS_SECRET_ACCESS_KEY: "{{ DO_secret_key }}"
    RESTIC_PASSWORD: "{{ restic_password }}"
  vars:
    host_configs:
      main:
        backup_name: "main-{{ ansible_date_time.date }}"
        backup_dir: /local/backups
        role: backupMain
      downloads:
        backup_name: "downloads-{{ ansible_date_time.date }}"
        domain: "{{ downloads_domain }}"
        docroot: "{{ downloads_docroot }}"
        role: backupOtherProperties
      shared:
        backup_name: "shared-{{ ansible_date_time.date }}"
        domain: "{{ shared_domain }}"
        docroot: "{{ shared_docroot }}"
        role: backupOtherProperties
      wiki:
        backup_name: "wiki-{{ ansible_date_time.date }}"
        domain: "{{ wiki_domain }}"
        docroot: "{{ wiki_docroot }}"
        role: backupOtherProperties
  roles:
    - role: "{{ host_configs[host_name].role }}"
      vars:
        property: "{{ host_name }}"
        backup_name: "{{ host_configs[host_name].backup_name }}"
        domain: "{{ host_configs[host_name].domain }}"
        docroot: "{{ host_configs[host_name].docroot }}"
        backup_dir:  "{{ host_configs[host_name].backup_dir }}"
