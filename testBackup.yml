- hosts:
  - museum

  become: yes
  become_user: root

  tasks:

  - name: Create backup dir
    file:
      path: /home/backup
      state: directory

  - name: Create content file to backup
    copy:
      dest: "{{ item }}"
      content: 'Hello backup!'
    loop:
      - /home/backup/test.txt
      - /home/backup/test.conf
      - /home/backup/test.md
      - /home/backup/test.sh

  - name: Install restic
    package:
      name: restic
      state: present

  - name: Initialize Restic
    command:
      cmd: restic -r s3:{{ DO_bucket_url }}/{{ DO_bucket_name }} init
      creates: /home/backup/.restic
    environment:
      AWS_ACCESS_KEY_ID: "{{ DO_access_key }}"
      AWS_SECRET_ACCESS_KEY: "{{ DO_secret_key }}"
      RESTIC_PASSWORD: "{{ restic_password }}"
    ignore_errors: true # this errors when it is already initialized

  - name: Run backup with Restic
    command:
      cmd: restic -r s3:{{ DO_bucket_url }}/{{ DO_bucket_name }} backup /home/backup
    environment:
      AWS_ACCESS_KEY_ID: "{{ DO_access_key }}"
      AWS_SECRET_ACCESS_KEY: "{{ DO_secret_key }}"
      RESTIC_PASSWORD: "{{ restic_password }}"


